"use strict";(self.webpackChunkRAMN_docs=self.webpackChunkRAMN_docs||[]).push([["487"],{875:function(e,n,s){s.r(n),s.d(n,{default:()=>h});var r=s(5893),i=s(65);function d(e){let n=Object.assign({h1:"h1",a:"a",p:"p",ul:"ul",li:"li",h2:"h2",strong:"strong",h3:"h3",pre:"pre",code:"code",img:"img",div:"div"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"与-iso-tp-交互",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#与-iso-tp-交互",children:"#"}),"与 ISO-TP 交互"]}),"\n",(0,r.jsxs)(n.p,{children:["如 ",(0,r.jsx)(n.a,{href:"/docs/userguide/can_tutorial.html#%E4%B8%8E-can-%E4%BA%A4%E4%BA%92",children:"与 CAN 交互"})," 中所述，ECU 通常会通过 CAN 提供诊断功能，并遵循若干标准文档的要求："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Unified_Diagnostic_Services",rel:"noopener noreferrer",target:"_blank",children:"统一诊断服务（UDS）"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Keyword_Protocol_2000",rel:"noopener noreferrer",target:"_blank",children:"关键字协议 2000（KWP2000）"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/XCP_(protocol)",rel:"noopener noreferrer",target:"_blank",children:"通用测量与标定协议（XCP）"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["诊断涉及客户端（诊断工具）与服务器（ECU）之间的大量数据传输，例如将新的固件文件发送到 ECU。 CAN 帧的有效载荷最多只能容纳 8 字节（对于 CAN FD 则为 64 字节），因此最好使用传输层来支持更大有效载荷的传输。 ",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/ISO_15765-2",rel:"noopener noreferrer",target:"_blank",children:"ISO-TP（ISO 15765-2）"}),"（有时也称为 CAN-TP）是一种传输层，旨在促进此类数据传输。"]}),"\n",(0,r.jsxs)(n.h2,{id:"iso-tp-基础",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#iso-tp-基础",children:"#"}),"ISO-TP 基础"]}),"\n",(0,r.jsx)(n.p,{children:"ISO-TP（ISO 15765-2）是 UDS 和 KWP2000 使用的传输层。它允许传输最大达 4095 字节的有效载荷。其工作原理是将每个 CAN 帧的第一个字节（或多个字节）用作报头，这一点与 IP 协议占用以太网帧前几个字节的方式类似。"}),"\n",(0,r.jsxs)(n.p,{children:["ISO-TP 通常用于建立一对一的通信通道：一个客户端和一个服务器。客户端通过发送具有特定（静态）标识符的 CAN 帧来发出请求，而服务器则通过发送具有另一个特定（静态）标识符的 CAN 帧进行响应。例如，RAMN 的 ECU B 监听 ID 为 0x7e1 的 CAN 帧（由诊断工具发送），并将其解释为 ISO-TP 帧，然后通过发送 ID 为 0x7e9 的 CAN 帧作出应答。这称为",(0,r.jsx)(n.strong,{children:"正常寻址"})," ,但还有其他类型的寻址方式（参见",(0,r.jsx)(n.a,{href:"#%E5%AF%BB%E5%9D%80",children:"寻址"}),"）。"]}),"\n",(0,r.jsxs)(n.p,{children:["ISO-TP 报头采用",(0,r.jsx)(n.strong,{children:"动态大小"}),"的报头（协议控制信息，PCI）。报头的类型由报头的第一个半字节（ ",(0,r.jsx)(n.strong,{children:"前四位"})," )定义。共有四种类型的报头："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"单帧 [SF，首字节为 0X]"}),"：这是用于 ISO-TP 有效载荷的单字节报头，适用于 7 字节或更短的有效载荷。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"首帧 [FF，首字节为 1X]"}),"：这是一个两字节报头，用于",(0,r.jsx)(n.strong,{children:"启动"})," 8 字节或更长 ISO-TP 有效载荷的传输。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"连续帧 [CF，首字节为 2X]"}),"：这是一个单字节报头，用于",(0,r.jsx)(n.strong,{children:"延续"}),"由“首帧”报头开始的传输。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"流控帧 [FC，首字节为 3X]"}),"：这是一个三字节报头，由",(0,r.jsx)(n.strong,{children:"接收方"}),"用来控制 ISO-TP 传输的速度。"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"尽管 ISO-TP 具备流控机制，但它并未包含用于确认帧已正确重组的“确认”机制。表示 ISO-TP 数据的 CAN 帧可能会用任意值进行填充（常见的填充值包括 0xCC、0xAA 和 0x00），以确保其始终为 8 字节长度。"}),"\n",(0,r.jsxs)(n.h3,{id:"单帧",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#单帧",children:"#"}),"单帧"]}),"\n",(0,r.jsx)(n.p,{children:"单帧（报头格式为“0X”）是简单的 ISO-TP 帧：其报头表明，整个 ISO-TP 有效载荷包含在 CAN 帧中，位于报头之后。这意味着该 ISO-TP 帧的长度为 7 字节或更短，否则有效载荷及其一字节的报头将无法容纳在一个单独的 CAN 帧中。"}),"\n",(0,r.jsx)(n.p,{children:"第二个半字节的值表示 ISO-TP 有效载荷的长度。例如，“01”表示一个字节的 ISO-TP 有效载荷，“05”则表示五字节的 ISO-TP 有效载荷。"}),"\n",(0,r.jsx)(n.p,{children:"对于单帧而言，无需流量控制，因此单帧即代表了整个 ISO-TP 传输过程。例如，如果诊断工具希望向 ECU B 发送 ISO-TP 有效载荷“00 11 22 33 44”（5 字节），它将发送以下 CAN 帧："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"ID: 0x7e1  DLC: 6  Payload: 05 00 11 22 33 44\n"})}),"\n",(0,r.jsxs)(n.p,{children:["请注意，ISO-TP 有效载荷的大小为 ",(0,r.jsx)(n.strong,{children:"5 字节"})," ,但相关的 CAN 帧却是 ",(0,r.jsx)(n.strong,{children:"6 字节"})," ,因为 CAN 帧中有一字节用作报头。"]}),"\n",(0,r.jsxs)(n.h3,{id:"首帧与连续帧",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#首帧与连续帧",children:"#"}),"首帧与连续帧"]}),"\n",(0,r.jsxs)(n.p,{children:["首帧（报头格式为“1XXX”）与连续帧（报头格式为“2X”）配合使用，以传输大于 7 字节的有效载荷。首帧指定了 ISO-TP 有效载荷的长度，并且",(0,r.jsx)(n.strong,{children:"包含该有效载荷的前 6 个字节"})," 。首字节的第二位半字节与报头的第二个字节拼接后，表示有效载荷的长度。例如，“10 09”的报头表示一个 9 字节的 ISO-TP 帧，“1F FF”则表示一个 0xFFF（4095）字节的 ISO-TP 帧。"]}),"\n",(0,r.jsx)(n.p,{children:"连续帧包含该有效载荷的剩余部分。报头字节的第二位半字节用作索引，以确保有效载荷能够按顺序重新组装。"}),"\n",(0,r.jsx)(n.p,{children:"例如，如果诊断工具希望将 ISO-TP 有效载荷“00 11 22 33 44 55 66 77 88 99 AA BB CC DD”（共 14 字节）发送至 ECU B，则会发送以下 CAN 帧："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"ID: 0x7e1  DLC: 8  Payload: 10 0E 00 11 22 33 44 55\r\nID: 0x7e1  DLC: 8  Payload: 21 66 77 88 99 AA BB CC\r\nID: 0x7e1  DLC: 2  Payload: 22 DD\n"})}),"\n",(0,r.jsxs)(n.p,{children:["请注意，这代表了诊断工具所发送的全部内容，但对于大于7字节的帧，诊断工具实际上",(0,r.jsx)(n.strong,{children:"必须等待流控制帧"}),"，如下文所述。"]}),"\n",(0,r.jsxs)(n.h3,{id:"流量控制帧",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#流量控制帧",children:"#"}),"流量控制帧"]}),"\n",(0,r.jsxs)(n.p,{children:["流量控制帧（报头格式为“3XYYZZ”）由 ISO-TP ",(0,r.jsx)(n.strong,{children:"接收方"}),"发送，用于控制传输速度。由于此类帧由接收方发送，因此其使用的 CAN ID 与其他帧不同。作为对“首帧”的响应，至少总会发现一个流量控制帧。"]}),"\n",(0,r.jsx)(n.p,{children:"流量控制帧的格式为“3X YY ZZ”，包含以下参数："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"标志位[X，4 位]"}),"：此字段包含实际的流量控制数据。1 表示“继续”，2 表示“等待”，3 表示“中止”。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"块大小 [YY, 8 位]"}),"：此参数指定客户端在等待下一个流量控制帧之前应发送的帧数。0 表示“无需等待，直接发送所有内容”。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"最小分离时间 (STmin) [ZZ, 8 位]"}),"：此字段指定了客户端在帧传输之间应等待的时间。0 表示“尽可能快速发送”，取值范围为 1 到 127 时，表示以毫秒为单位的延迟。0xF1 至 0xF9 用于指定 100 毫秒到 900 毫秒之间的较大延迟。介于这些值之间的数值已被标准保留。"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"现代 ECU 通常会以“30 00 00”作为对“第一帧”的响应，这意味着“以最高速度发送所有数据”——在这种情况下，这将是整个通信过程中唯一的流控制帧。"}),"\n",(0,r.jsx)(n.p,{children:"如果 ECU 回复的是“30 00 F9”，客户端也会在不等待流控制帧的情况下发送所有帧，但每帧之间会间隔 900 毫秒。"}),"\n",(0,r.jsx)(n.p,{children:"如果 ECU 回复的是“30 01 00”，客户端将发送第一个“连续帧”，并在继续发送之前等待另一个流控制帧。"}),"\n",(0,r.jsxs)(n.h3,{id:"示例",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#示例",children:"#"}),"示例"]}),"\n",(0,r.jsx)(n.p,{children:"以下是一个完整的 ISO-TP 传输示例："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'ID: 0x7e1  DLC: 8  Payload: 10 0E 00 11 22 33 44 55 ("I want to send a 14-byte payload, here are the first bytes")\r\nID: 0x7e9  DLC: 3  Payload: 30 00 00 ("Send the rest without waiting, at maximum speed")\r\nID: 0x7e1  DLC: 8  Payload: 21 66 77 88 99 AA BB CC ("Here is the second part")\r\nID: 0x7e1  DLC: 2  Payload: 22 DD ("Here is the third part")\n'})}),"\n",(0,r.jsx)(n.p,{children:"请注意，最后没有确认应答。如果 ECU 使用的块大小不为零，则相同的数据交换将如下所示。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'ID: 0x7e1  DLC: 8  Payload: 10 0E 00 11 22 33 44 55 ("I want to send a 14-byte payload, here are the first bytes")\r\nID: 0x7e9  DLC: 3  Payload: 30 01 00 ("Send one CAN frame and wait")\r\nID: 0x7e1  DLC: 8  Payload: 21 66 77 88 99 AA BB CC ("Here is the second part")\r\nID: 0x7e9  DLC: 3  Payload: 30 01 00 ("Send one CAN frame and wait")\r\nID: 0x7e1  DLC: 2  Payload: 22 DD ("Here is the third part")\n'})}),"\n",(0,r.jsxs)(n.h2,{id:"linux-上的-iso-tp",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#linux-上的-iso-tp",children:"#"}),"Linux 上的 ISO-TP"]}),"\n",(0,r.jsxs)(n.p,{children:["can-utils 软件包提供了",(0,r.jsx)(n.a,{href:"https://github.com/linux-can/can-utils/blob/master/README.md",rel:"noopener noreferrer",target:"_blank",children:"多种工具"}),"用于与 ISO-TP 交互。您可能会用到以下三个命令：",(0,r.jsx)(n.strong,{children:"isotpsend"})," 用于发送 ISO-TP 帧，",(0,r.jsx)(n.strong,{children:"isotprecv"})," 用于接收 ISO-TP 帧，以及 ",(0,r.jsx)(n.strong,{children:"isotpdump"})," 用于转储并解析 ISO-TP 流量。此外，您仍然可以使用前一指南中介绍的基本命令（参见",(0,r.jsx)(n.a,{href:"/docs/userguide/can_tutorial.html#%E4%B8%8E-can-%E4%BA%A4%E4%BA%92",children:"与 CAN 交互"}),"）。"]}),"\n",(0,r.jsxs)(n.p,{children:["UDS 命令将在另一节中详细说明。本节主要使用基本的 UDS 命令 “3E 00”，该命令应由 ECU 回应 “7E 00”。我们将此命令发送至 ECU B，它使用 ID 0x7e1 接收命令，使用 ID 0x7e9 回应命令。任何其他随机命令，很可能是无效的，应以 ",(0,r.jsx)(n.code,{children:"7F <您发送的第一个字节> <错误码字节>"})," 来回应，以指示您的命令存在错误。"]}),"\n",(0,r.jsxs)(n.h3,{id:"candump",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#candump",children:"#"}),"candump"]}),"\n",(0,r.jsx)(n.p,{children:"在使用 ISO-TP 进行实验时，你可能希望显示原始的 CAN 流量。这可以通过使用 candump 并配合正确的过滤器来实现。例如，如果你只想显示 ECU B 的 ISO-TP 流量对应的 CAN 帧，则应仅显示 ID 为 0x7e1 和 0x7e9 的 CAN 帧："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"candump can0,7e1:7ff,7e9:7ff\n"})}),"\n",(0,r.jsxs)(n.p,{children:["如果您想显示现代车辆中通常出现的所有 ISO-TP 帧，可以使用 ID 介于 0x7e0 和 0x7f 之间的过滤器来筛选帧（请参阅 ",(0,r.jsx)(n.a,{href:"/docs/userguide/can_tutorial.html#can-%E8%BF%87%E6%BB%A4%E5%99%A8",children:"CAN 过滤器 "}),"）："]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"candump can0,7e0:7f0\n"})}),"\n",(0,r.jsx)(n.p,{children:"在试验 ISO-TP 时，建议您始终保留一个终端执行此命令，以便可以直接观察 CAN 帧。"}),"\n",(0,r.jsxs)(n.h3,{id:"cansend",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#cansend",children:"#"}),"cansend"]}),"\n",(0,r.jsx)(n.p,{children:"尽管不推荐这样做，但并没有任何限制阻止您手动创建 ISO-TP 报头并发送 CAN 帧。要将 ISO-TP 有效载荷“3E 00”发送到 ECU B，您可以输入以下命令："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"cansend can0 7e1#023E00\n"})}),"\n",(0,r.jsx)(n.p,{children:"在您的 candump 终端上，您应该会看到两条消息："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"您的请求（“3E 00”，由您通过 ID 0x7e1 发送）。"}),"\n",(0,r.jsx)(n.li,{children:"ECU 的响应（“7E 00”，由 ECU B 通过 ID 0x7e9 发送）。"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/cansend_isotp.webp",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"请注意，CAN 帧的 DLC（有效载荷大小）为 3，但 ISO-TP 有效载荷仅为 2 字节——这是因为 CAN 有效载荷的第一个字节用于指示 ISO-TP 有效载荷的大小。此外，请注意，您的请求 CAN 报文中并未指定响应 CAN ID，该 ID 是静态设定的，不同于 TCP 等其他协议中的源端口和目的端口。"}),"\n",(0,r.jsx)(n.p,{children:"如果您忽略流控制帧，并仅寄希望于时间 timing 正确，也可以直接发送分段帧。例如，要发送有效载荷 00 11 22 33 44 55 66 77（8 字节），您可以输入："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"cansend can0 7e1#1008001122334455 && cansend can0 7e1#216677\n"})}),"\n",(0,r.jsx)(n.p,{children:"并在 candump 中观察响应结果。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/cansend_isotp2.webp",alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["尽管在 ISO-TP 上层可能会出现错误信息（例如上述截图中的“7F 00 31”UDS 错误消息），但 ",(0,r.jsx)(n.strong,{children:"在 ISO-TP 层却没有任何错误信息"})," 。如果在格式化 ISO-TP 帧时出现错误，ECU 将直接不予响应。例如，对于以下格式错误的请求，ECU 不会作出任何回应，也不会报告相关错误。"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/cansend_isotp3.webp",alt:""})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/cansend_isotp4.webp",alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["ECU 通常对 ISO-TP 请求设置了非常快速的超时机制，如果帧发送不够迅速，传输将被关闭。建议您不要自行格式化 ISO-TP 帧，而是使用诸如 ",(0,r.jsx)(n.strong,{children:"isotpsend"})," 之类的工具。"]}),"\n",(0,r.jsxs)(n.h3,{id:"isotpsend",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#isotpsend",children:"#"}),"isotpsend"]}),"\n",(0,r.jsx)(n.p,{children:"命令 isotpsend 允许您向 ISO-TP 服务器发送任意有效载荷。作为参数，您需要提供 CAN 接口、源 CAN ID（客户端用于传输数据的 ID）以及目标 CAN ID（服务器用于传输流控帧的 ID）。有效载荷必须通过标准输入逐字节提供。在 Linux 中，这可以使用 echo 命令来完成。例如，使用以下命令将两字节的 ISO-TP 有效载荷“3E 00”发送到 ECU B："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'echo "3E 00" | isotpsend -s 7e1 -d 7e9 can0\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpsend_test.webp",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"这与之前使用 candump 捕获的 CAN 流量完全相同，只不过这次您无需自己添加报头。不过，您仍需提供目标 ID，因为 isotpsend 会等待流控帧的到来。"}),"\n",(0,r.jsx)(n.p,{children:"注意"}),"\n",(0,r.jsxs)(n.p,{children:["请注意，“源”对应于目标 ECU 所监听的 ID——这一点对某些人来说可能有些反直觉。与 TCP 协议中的“源”和“目的”的类比存在局限性：对于 ISO-TP 而言，“源”和“目的”ID 是一组静态配对。如果你想与另一个 ECU 通信，你需要同时更改",(0,r.jsx)(n.strong,{children:"源"}),"和",(0,r.jsx)(n.strong,{children:"目的"})," 。"]}),"\n",(0,r.jsx)(n.p,{children:"你可以使用 isotpsend 发送最大 4095 字节的有效载荷，而无需担心 ISO-TP 的格式问题。例如："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'echo "00 11 22 33 44 55 66 77 88 99 AA BB CC DD EE FF 00 11 22 33" | isotpsend -s 7e1 -d 7e9 can0\n'})}),"\n",(0,r.jsx)(n.p,{children:"应显示如下截图所示的流量。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpsend_test3.webp",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"如果你只想测试 ISO-TP 链路，而对有效载荷内容不关心，可以使用-D 选项让 isotpsend 为你生成特定大小的有效载荷。此外，你还可以使用-f 功能来强制设置客户端分离时间的值（单位为纳秒）。例如，使用以下命令生成一个 100 字节的有效载荷，并在每次传输之间设置 1 秒的延迟："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpsend -s 7e1 -d 7e9 -D 100 -f 1000000000 can0\n"})}),"\n",(0,r.jsx)(n.p,{children:"你应该能够在 candump 终端中观察到缓慢的传输过程。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpsend_test2.webp",alt:""})}),"\n",(0,r.jsxs)(n.h3,{id:"isotprecv",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#isotprecv",children:"#"}),"isotprecv"]}),"\n",(0,r.jsx)(n.p,{children:"命令 isotpsend 允许您发送 ISO-TP 帧，但它不会监听来自服务器（ECU）的响应。为此，您需要在另一个终端中使用 isotprecv，并指定相同的参数："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotprecv -s 7e1 -d 7e9 can0\n"})}),"\n",(0,r.jsx)(n.p,{children:"这将接收一个有效载荷后关闭，但您可以使用 -l 选项来监听多个 ISO-TP 有效载荷："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotprecv -s 7e1 -d 7e9 -l can0\n"})}),"\n",(0,r.jsx)(n.p,{children:"如果您在一个终端中打开其中一条命令，并在另一个终端中使用 isotpsend，那么您应该能够在 isotprecv 终端中看到 ECU 对您的 ISO-TP 有效载荷的响应。例如，在另一个终端中输入以下命令："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'echo "3E 00" | isotpsend -s 7e1 -d 7e9 can0\n'})}),"\n",(0,r.jsx)(n.p,{children:"然后观察 isotprecv 终端，它应该会显示来自 ECU 的响应。"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotprecv_test.webp",alt:""})}),"\n",(0,r.jsxs)(n.div,{className:"rspress-directive warning",children:[(0,r.jsx)(n.div,{className:"rspress-directive-title",children:"警告"}),(0,r.jsxs)(n.div,{className:"rspress-directive-content",children:[(0,r.jsxs)(n.p,{children:["使用 isotprecv 和 isotpsend 时，请勿混淆源和目标——它们应使用相同的参数。如果您改为使用 ",(0,r.jsx)(n.code,{children:"isotprecv -s 7e9 -d 7e1 can0"}),",您将不会监听 ECU B 的响应，而是会伪装成 ECU B，并监听与之相同的命令。通常情况下，真实 ECU 中的源 ID 低于目标 ID，因此："]}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"如果第一个参数小于第二个参数，则您正在监听 ECU 的响应（典型用法）。"}),"\n",(0,r.jsx)(n.li,{children:"如果第二个参数小于第一个参数，则您正在伪装成一个 ECU（例如，如果您想开发一个 ECU 模拟器）。"}),"\n"]})]})]}),"\n",(0,r.jsx)(n.p,{children:"请注意，请求不会显示在 isotprecv 中，仅显示响应。您可以使用 isotpdump 在同一终端中同时显示请求和响应。"}),"\n",(0,r.jsxs)(n.h3,{id:"isotpdump",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#isotpdump",children:"#"}),"isotpdump"]}),"\n",(0,r.jsx)(n.p,{children:"命令 isotpdump 将在同一窗口中同时显示请求和响应。与 candump 类似，建议您保持一个终端窗口始终打开该命令。"}),"\n",(0,r.jsx)(n.p,{children:"使用以下命令转储您与 ECU B 之间的流量："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpdump -s 7e1 -d 7e9 -c can0\n"})}),"\n",(0,r.jsx)(n.p,{children:"-c 选项为消息添加颜色，以便轻松区分请求（红色）和响应（蓝色）。"}),"\n",(0,r.jsx)(n.p,{children:"如果您在另一个终端中输入以下 isotpsend 命令，应该能够观察到 ISO-TP 流量。"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'echo "3E 00" | isotpsend -s 7e1 -d 7e9 can0\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpdump_test.webp",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"您可以使用-a 选项以显示 ASCII 格式，并使用-u 选项将有效载荷解释为 UDS 流量："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpdump -s 7e1 -d 7e9 -c can0 -a -u\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpdump_test3.webp",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"与 candump 不同，isotpdump 会自动去除报头，方便您直接识别实际的 ISO-TP 有效载荷。不过，它仍然会逐个显示 CAN 帧。当有效载荷较大时，这种显示方式可能会显得有些繁杂，例如："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpsend -s 7e1 -d 7e9 can0 -D 200\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpdump_test2.webp",alt:""})}),"\n",(0,r.jsxs)(n.h3,{id:"isotpsniffer",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#isotpsniffer",children:"#"}),"isotpsniffer"]}),"\n",(0,r.jsx)(n.p,{children:"如果您只想查看重构的有效载荷，可以改用 isotpsniffer。您可以使用以下语法："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpsniffer -s 7e1 -d 7e9 can0 -c\n"})}),"\n",(0,r.jsx)(n.p,{children:"这应该只会显示重构后的有效载荷，例如在使用 isotpsend 传输大容量有效载荷时："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpsend -s 7e1 -d 7e9 can0 -D 100\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpsniffer_test.webp",alt:""})}),"\n",(0,r.jsxs)(n.h3,{id:"isotpperf",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#isotpperf",children:"#"}),"isotpperf"]}),"\n",(0,r.jsx)(n.p,{children:"您可以使用 isotpperf 来测量 ISO-TP 连接的性能，例如针对 ECU B："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpperf -s 7e1 -d 7e9 can0\n"})}),"\n",(0,r.jsx)(n.p,{children:"这将显示正在进行的传输，并测量其耗时。"}),"\n",(0,r.jsx)(n.p,{children:"您可以通过本地强制设置-STmin 值（使用-f 选项）来尝试各种传输。打开另一个窗口，输入以下命令以发送最大尺寸且具有不同时间间隔的有效载荷："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpsend -s 7e1 -d 7e9 can0 -f 100000 -D 4095\r\nisotpsend -s 7e1 -d 7e9 can0 -f 1000000 -D 4095\r\nisotpsend -s 7e1 -d 7e9 can0 -f 10000000 -D 4095\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpperf_test.webp",alt:""})}),"\n",(0,r.jsxs)(n.h3,{id:"isotpserver",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#isotpserver",children:"#"}),"isotpserver"]}),"\n",(0,r.jsx)(n.p,{children:"如果您希望通过 IP 网络访问 ECU 的 ISO-TP 服务器，可以使用 isotpserver。例如，如果您希望将来自 ECU B（ISO-TP 对 0x7e1/0x7e9）的 ISO-TP 流量转发到 IP 端口 7777，可以使用以下命令："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"isotpserver -s 7e1 -d 7e9 -l 7777 can0\n"})}),"\n",(0,r.jsxs)(n.div,{className:"rspress-directive warning",children:[(0,r.jsx)(n.div,{className:"rspress-directive-title",children:"警告"}),(0,r.jsx)(n.div,{className:"rspress-directive-content",children:(0,r.jsx)(n.p,{children:"此命令允许任何能够访问您 IP 服务器的人员与 ECU B 进行通信。请仅在您清楚自己操作的情况下使用此功能。"})})]}),"\n",(0,r.jsx)(n.p,{children:"您可以使用例如 netcat 连接到此端口："}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"nc localhost 7777\n"})}),"\n",(0,r.jsxs)(n.p,{children:["您可以发送以 ASCII 格式嵌入在尖括号 ",(0,r.jsx)(n.code,{children:"<>"})," 中的 ISO-TP 帧，例如，如果您输入 ",(0,r.jsx)(n.code,{children:"<3E00>"})," 并按下回车键，您应在同一终端中收到 ",(0,r.jsx)(n.code,{children:"<7E00>"})," 。"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"/userguide/isotpserver_test.webp",alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["此命令可用于远程与多人共享一个 ECU。但请注意，只有 ISO-TP 响应（且仅限响应）会被广播给所有客户端。您还可以使用 ",(0,r.jsx)(n.strong,{children:"isotptun"})," 命令创建基于 ISO-TP 的 IP 隧道。"]}),"\n",(0,r.jsxs)(n.h2,{id:"略微高级-iso-tp-概念",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#略微高级-iso-tp-概念",children:"#"}),"（略微）高级 ISO-TP 概念"]}),"\n",(0,r.jsxs)(n.h3,{id:"物理寻址与功能寻址",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#物理寻址与功能寻址",children:"#"}),"物理寻址与功能寻址"]}),"\n",(0,r.jsx)(n.p,{children:"寻址方式有两种："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"物理寻址"}),"\n",(0,r.jsx)(n.li,{children:"功能寻址"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"在正常寻址模式下，诊断工具一次仅与一个 ECU 进行通信。"}),"\n",(0,r.jsxs)(n.p,{children:["在功能寻址中，诊断工具可以同时与一组 ECU 进行通信。它仅支持单帧，因为单帧无需流量控制，因此多个接收端可轻松同时接收。ECU 常用的函数地址为 0x7DF，该地址由 ",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/OBD-II_PIDs",rel:"noopener noreferrer",target:"_blank",children:"OBD-II PID"})," 定义。"]}),"\n",(0,r.jsxs)(n.h3,{id:"寻址",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#寻址",children:"#"}),"寻址"]}),"\n",(0,r.jsx)(n.p,{children:"ISO-TP 中定义了多种寻址类型："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"普通寻址"})," ：地址 ID 完全包含在 CAN 标识符中（例如，ECU B 的 0x7e1 和 0x7e9）。它适用于标准（11 位）和扩展（29 位）CAN 标识符。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"普通固定寻址"})," ：这是普通寻址的一种子格式，仅适用于 29 位扩展标识符，其中地址必须遵循 ",(0,r.jsx)(n.a,{href:"https://www.csselectronics.com/pages/j1939-explained-simple-intro-tutorial",rel:"noopener noreferrer",target:"_blank",children:"J1939 格式 "}),"。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"扩展寻址"})," ：CAN 有效载荷的第一个字节用作额外的地址字节。这意味着单帧和连续帧的报头大小变为两个字节，首帧为三个字节，流控帧则为四个字节。"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"混合寻址"})," ：正常固定寻址与扩展寻址的混合使用。"]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"can-fd",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#can-fd",children:"#"}),"CAN FD"]}),"\n",(0,r.jsxs)(n.p,{children:["较新版本的 ISO-TP 利用了 CAN FD 提供的额外带宽（参见 ",(0,r.jsx)(n.a,{href:"/docs/userguide/can_tutorial.html#can-fd",children:"CAN FD"}),"）。具体而言："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"单帧可容纳最多 62 字节的有效载荷。为此，CAN 帧的第一个字节应为“00”，而紧随其后的字节则用于指示 ISO-TP 有效载荷的大小（最多 62 字节，因为前两个字节已被报头占用）。"}),"\n",(0,r.jsx)(n.li,{children:"分段帧（首帧+连续帧）可容纳最大 4GB 大小的有效载荷。为此，前两个字节应为“1000”，而随后的四个字节则用于指示 ISO-TP 有效载荷的大小。"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"故障排除",children:[(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#故障排除",children:"#"}),"故障排除"]}),"\n",(0,r.jsx)(n.p,{children:"如果您遇到超时问题（例如出现“read socket t: Connection timed out”之类的错误信息），这表明连接不可靠，即以下情况之一："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"ECU A（您的 USB 转 CAN 适配器）将数据从 USB 传输到 CAN 的速度不够快。"}),"\n",(0,r.jsx)(n.li,{children:"您的 PC 通过 USB 发送的数据不正确。"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"如果问题出在 ECU A 上，其屏幕上应会显示错误信息。"}),"\n",(0,r.jsx)(n.p,{children:"如果您使用的是虚拟机，其 USB 设置可能不够可靠。在 VirtualBox 中，前往“设置”->“USB”，并勾选“USB 3.0 (xHCI) 控制器”（请确保您的虚拟机已关闭）。"}),"\n",(0,r.jsx)(n.p,{children:"如果仍然失败，请尝试使用 -f 选项与 isotpsend 配合，以强制其降低速度，例如使用“-f 100000”。"})]})}function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,Object.assign({},e,{children:(0,r.jsx)(d,e)})):d(e)}let h=c;c.__RSPRESS_PAGE_META={},c.__RSPRESS_PAGE_META["docs%2Fuserguide%2Fisotp_tutorial.mdx"]={toc:[{id:"iso-tp-基础",text:"ISO-TP 基础",depth:2},{id:"单帧",text:"单帧",depth:3},{id:"首帧与连续帧",text:"首帧与连续帧",depth:3},{id:"流量控制帧",text:"流量控制帧",depth:3},{id:"示例",text:"示例",depth:3},{id:"linux-上的-iso-tp",text:"Linux 上的 ISO-TP",depth:2},{id:"candump",text:"candump",depth:3},{id:"cansend",text:"cansend",depth:3},{id:"isotpsend",text:"isotpsend",depth:3},{id:"isotprecv",text:"isotprecv",depth:3},{id:"isotpdump",text:"isotpdump",depth:3},{id:"isotpsniffer",text:"isotpsniffer",depth:3},{id:"isotpperf",text:"isotpperf",depth:3},{id:"isotpserver",text:"isotpserver",depth:3},{id:"略微高级-iso-tp-概念",text:"（略微）高级 ISO-TP 概念",depth:2},{id:"物理寻址与功能寻址",text:"物理寻址与功能寻址",depth:3},{id:"寻址",text:"寻址",depth:3},{id:"can-fd",text:"CAN FD",depth:3},{id:"故障排除",text:"故障排除",depth:3}],title:"与 ISO-TP 交互",headingTitle:"与 ISO-TP 交互",frontmatter:{}}}}]);